<!DOCTYPE html>
<html>
    
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <title>
            Build Node.Js web server in Docker containers: nodejs+pm2+mongodb+redis - Dogs Blog
        </title>
        <link rel="shortcut icon" href="../dist/favicon.ico">
        <link rel="stylesheet" href="../dist/post.style.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/github-markdown-css/2.2.1/github-markdown.css">
        <link rel="stylesheet" href="http://cdn.bootcss.com/highlight.js/9.2.0/styles/github-gist.min.css">
    </head>
    
    <body>
        <div class="header">
            <button class="label reverse"><a href="../#/category/all">返回列表</a></button>
        </div>

<div class="post-header">
    分类: OPS | 发布日期: 2016-07-17
</div>
<div class="divider"></div>
<div class="markdown-body">
    <h1 id="build-nodejs-web-server-in-docker-containers:-nodejs+pm2+mongodb+redis">Build Node.Js web server in Docker containers: nodejs+pm2+mongodb+redis</h1><!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<ul>
<li><a href="#%E7%8E%AF%E5%A2%83">环境</a></li>
<li><a href="#%E4%B8%8B%E8%BD%BD%E4%BD%BF%E7%94%A8%E9%95%9C%E5%83%8F">下载使用镜像</a></li>
<li><a href="#%E5%9F%BA%E4%BA%8E-nodejs-%E9%95%9C%E5%83%8F%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1%E9%95%9C%E5%83%8F">基于 Node.Js 镜像创建服务镜像</a></li>
<li><a href="#%E5%9F%BA%E4%BA%8E-nodejs-%E9%95%9C%E5%83%8F%E4%BD%BF%E7%94%A8-pm2">基于 Node.Js 镜像使用 pm2</a><ul>
<li><a href="#%E4%BD%BF%E7%94%A8-pm2">使用 pm2</a></li>
<li><a href="#%E5%B0%86-pm2%E3%80%81log4js-%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E5%88%B0%E5%AE%BF%E4%B8%BB%E6%9C%BA%E6%96%87%E4%BB%B6">将 pm2、log4js 日志记录到宿主机文件</a></li>
</ul>
</li>
<li><a href="#%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5-nodejs&amp;mongodb&amp;redis">应用实践 nodejs&amp;mongodb&amp;redis</a><ul>
<li><a href="#%E5%9F%BA%E4%BA%8E-centos-%E9%95%9C%E5%83%8F%E5%88%9B%E5%BB%BA-mongodb-%E9%95%9C%E5%83%8F">基于 centos 镜像创建 mongodb 镜像</a></li>
<li><a href="#%E5%9F%BA%E4%BA%8E-centos-%E9%95%9C%E5%83%8F%E5%88%9B%E5%BB%BA-redis-%E9%95%9C%E5%83%8F">基于 centos 镜像创建 redis 镜像</a></li>
<li><a href="#%E5%9F%BA%E4%BA%8E-centos-%E9%95%9C%E5%83%8F%E5%88%9B%E5%BB%BA-nodejs-%E6%9C%8D%E5%8A%A1%E9%95%9C%E5%83%8F">基于 centos 镜像创建 nodejs 服务镜像</a></li>
<li><a href="#%E6%B5%8B%E8%AF%95">测试</a></li>
</ul>
</li>
<li><a href="#%E5%85%B6%E4%BB%96">其他</a><ul>
<li><a href="#%E4%BF%AE%E6%94%B9%E9%95%9C%E5%83%8F%E3%80%81%E5%AE%B9%E5%99%A8%E5%AD%98%E5%82%A8%E7%9B%AE%E5%BD%95">修改镜像、容器存储目录</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="环境">环境</h2><ul>
<li>系统环境 centos 6.5 64bit</li>
<li>docker v1.7.1</li>
</ul>
<h2 id="下载使用镜像">下载使用镜像</h2><pre><code>[root@dss ~]# docker search node # 搜素镜像
NAME                      DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED
node                      Node.js is a JavaScript-based platform for...   2462      [OK]       
strongloop/node           StrongLoop, Node.js, and tools.                 30                   [OK]
bitnami/node              Bitnami Node.js Docker Image                    16                   [OK]
siomiz/node-opencv        _/node + node-opencv                            8                    [OK]
dahlb/alpine-node         small node for gitlab ci runner                 7                    [OK]
tatsushid/tinycore-node   A small but a fully functional Node.js run...   6                    [OK]
cusspvz/node               Super small Node.js container (~20MB)...      4                    [OK]
azukiapp/node             Docker image to run Node.js by Azuki - htt...   4                    [OK]
tutum/node                Run a Tutum node inside a container             3                    [OK]
anigeo/node-forever       Daily build node.js with forever                3                    [OK]
redjack/node              Node + Nave                                     1                    [OK]
xataz/node                very light node image                           1                    [OK]
joxit/node                Slim node docker with some utils for dev        1                    [OK]
centralping/node          Bare bones CentOS 7 NodeJS container.           1                    [OK]
urbanmassage/node         Some handy (read, better) docker node images    1                    [OK]
tectoro/node-compass      Node JS minimal version with compass and b...   1                    [OK]
starefossen/ruby-node     Docker Image with Ruby and Node.js installed    1                    [OK]
atomiq/node               Use as base image for new Node.js images.       1                    [OK]
robbertkl/node            Docker container running Node.js                0                    [OK]
lynxtp/node               https://github.com/lynxtp/docker-node           0                    [OK]
codexsystems/node         Node.js for Development and Production          0                    [OK]
instructure/node          Instructure node images                         0                    [OK]
stylisted/node            Stylisted&#39;s base Docker node image with gr...   0                    [OK]
maxird/node               Node                                            0                    [OK]
c4tech/node               NodeJS images, aimed at generated single-p...   0                    [OK]
</code></pre><p>安装 Node.Js 官方镜像 <code>[root@dss ~]# yum pull node</code></p>
<p>查看已安装镜像</p>
<pre><code>[root@dss workspace]# docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
node                latest              47abb70784d6        8 days ago          660.6 MB
</code></pre><h2 id="基于-nodejs-镜像创建服务镜像">基于 Node.Js 镜像创建服务镜像</h2><p>新建目录 <code>src</code>, 在src目录下新建 <code>package.json</code>:</p>
<pre><code>{
    &quot;name&quot;: &quot;docker-node-test&quot;,
    &quot;private&quot;: true,
    &quot;version&quot;: &quot;0.0.1&quot;,
    &quot;description&quot;: &quot;Node.js test app on node docker image&quot;,
    &quot;author&quot;: &quot;Shaoshuai Dong &lt;dongsoso@hotmail.com&gt;&quot;,
    &quot;dependencies&quot;: {
        &quot;express&quot;: &quot;^4.13.4&quot;                                
    }
}
</code></pre><p>在src目录下新建<code>index.js</code>:</p>
<pre><code> const express = require(&#39;express&#39;);

 // Creates an Express application
 let app = express();

 // Assigns settings
 app.set(&#39;port&#39;, 8080);

 // Routes HTTP GET requests 
 app.get(&#39;/&#39;, (req, res) =&gt; {
     res.send(&#39;Hello world --- from nodejs docker image\n&#39;);
 });                                                          

 // Binds and listens
 app.listen(app.get(&#39;port&#39;), () =&gt; {
     console.info(&quot;Listen port %s for app&quot;, app.get(&quot;port&quot;));
</code></pre><p>在src同级目录下新建文件 <code>Dockerfile</code>: </p>
<pre><code>From node:6.3

ADD src/ /src

RUN cd /src; npm install

EXPOSE  8080

CMD [&quot;node&quot;, &quot;/src/index.js&quot;]
</code></pre><p>创建镜像 <code>docker build --tag=&quot;node/app-test&quot; ./</code>, <code>docker build --help</code> 查看详细参数</p>
<p>创建成功会提示 <code>Successfully built 2199b2aa9cd1</code></p>
<p>查看创建的镜像</p>
<pre><code>[root@dss test]# docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
node/app-test       latest              2199b2aa9cd1        7 seconds ago       663.6 MB
node                6.3                 47abb70784d6        8 days ago          660.6 MB
node                latest              47abb70784d6        8 days ago          660.6 MB
</code></pre><p>运行刚刚创建的镜像, <code>docker run --help</code> 查看详细参数：</p>
<pre><code>[root@dss test]# docker run -d -p 8081:8080 node/app-test 
873ac198368799f9bf56262e097f55e66241f47cedd336349236b43e9001539d
</code></pre><p>查看运行中的容器，是否存在：</p>
<pre><code>[root@dss test]# docker ps
CONTAINER ID        IMAGE               COMMAND                CREATED             STATUS              PORTS                    NAMES
873ac1983687        node/app-test       &quot;node /src/index.js&quot;   53 seconds ago      Up 52 seconds       0.0.0.0:8081-&gt;8080/tcp   desperate_swartz
</code></pre><p>测试 Node.Js 服务：</p>
<pre><code>[root@dss ~]# curl localhost:8081 -i
HTTP/1.1 200 OK
X-Powered-By: Express
Content-Type: text/html; charset=utf-8
Content-Length: 41
ETag: W/&quot;29-onjHxbOtTbPH0+vlfe2YtA&quot;
Date: Fri, 15 Jul 2016 10:49:54 GMT
Connection: keep-alive

Hello world --- from nodejs docker image
</code></pre><h2 id="基于-nodejs-镜像使用-pm2">基于 Node.Js 镜像使用 pm2</h2><h3 id="使用-pm2">使用 pm2</h3><p>创建 <code>Dockerfile</code>:</p>
<pre><code>From node:6.3

RUN npm install pm2 -g --registry=https://registry.npm.taobao.org
RUN mkdir -p /usr/src/node-app
WORKDIR /usr/src/node-app

COPY src/. /usr/src/node-app/

RUN npm install --registry=https://registry.npm.taobao.org

EXPOSE  8080

CMD [&quot;npm&quot;, &quot;start&quot;]
</code></pre><p>先看看目录结构吧</p>
<pre><code>[root@dss workspace]# tree test/
test/
├── Dockerfile
└── src
    ├── index.js
    ├── package.json
    └── pm2.json
</code></pre><p><code>package.json</code>:</p>
<pre><code>{                                                           
    &quot;name&quot;: &quot;docker-node-test&quot;,                             
    &quot;private&quot;: true,                                        
    &quot;version&quot;: &quot;0.0.1&quot;,                                     
    &quot;description&quot;: &quot;Node.js test app on node docker image&quot;, 
    &quot;author&quot;: &quot;Shaoshuai Dong &lt;dongsoso@hotmail.com&gt;&quot;,      
    &quot;scripts&quot;: {                                            
        &quot;start&quot;: &quot;pm2 startOrGracefulReload ./pm2.json --no-daemon&quot;     
    },                                                      
    &quot;dependencies&quot;: {                                       
        &quot;express&quot;: &quot;^4.13.4&quot;                                
    }                                                       
}
</code></pre><p><code>index.js</code></p>
<pre><code>const express = require(&#39;express&#39;);

// Creates an Express application
let app = express();

// Assigns settings
app.set(&#39;port&#39;, 8080);

// Routes HTTP GET requests                                       
app.get(&#39;/&#39;, (req, res) =&gt; {
    res.send(&#39;Hello world --- from nodejs docker image\n&#39;);
});

// Binds and listens
app.listen(app.get(&#39;port&#39;), () =&gt; {
    console.info(&quot;Listen port %s for app&quot;, app.get(&quot;port&quot;));
});
</code></pre><p><code>pm2.json</code>:</p>
<pre><code>{                                         
    &quot;apps&quot;: [
        {
            &quot;name&quot;: &quot;app-test&quot;,
            &quot;script&quot;      : &quot;index.js&quot;,
            &quot;args&quot;        : [],
            &quot;watch&quot;       : false,
            &quot;merge_logs&quot;  : true,
            &quot;max_memory_restart&quot;: &quot;100M&quot;,
            &quot;env&quot;: {
                &quot;NODE_ENV&quot;: &quot;local&quot;
            }
        }
    ]
}
</code></pre><p>创建镜像 <code>docker build --tag=&quot;node/app-test&quot; ./</code></p>
<p>查看创建的镜像 <code>docker images</code>:</p>
<pre><code>[root@dss test]# docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
node/app-test       latest              1a3325c28c8c        14 minutes ago      678 MB
node                latest              47abb70784d6        10 days ago         660.6 MB
node                6.3                 47abb70784d6        10 days ago         660.6 MB
</code></pre><p>运行 <code>docker run -d -p 8081:8080 node/app-test</code></p>
<p>查看运行中的容器</p>
<pre><code>[root@dss test]# docker ps
CONTAINER ID        IMAGE               COMMAND                CREATED             STATUS              PORTS                    NAMES
9e49f7c5270a        node/app-test       &quot;pm2 start index.js    7 minutes ago       Up 7 minutes        0.0.0.0:8081-&gt;8080/tcp   gloomy_sammet
</code></pre><p>测试</p>
<pre><code>[root@dss test]# curl -i localhost:8081
HTTP/1.1 200 OK
X-Powered-By: Express
Content-Type: text/html; charset=utf-8
Content-Length: 41
ETag: W/&quot;29-onjHxbOtTbPH0+vlfe2YtA&quot;
Date: Sun, 17 Jul 2016 09:12:48 GMT
Connection: keep-alive

Hello world --- from nodejs docker image
</code></pre><p>在容器内运行命令(<code>docker exec --help</code> 查看更多用法)</p>
<pre><code>[root@dss test]# docker exec -i 9e49f7c5270a pm2 list
┌──────────┬────┬──────┬─────┬────────┬─────────┬────────┬─────────────┬──────────┐
│ App name │ id │ mode │ pid │ status │ restart │ uptime │ memory      │ watching │
├──────────┼────┼──────┼─────┼────────┼─────────┼────────┼─────────────┼──────────┤
│ app-test │ 0  │ fork │ 17  │ online │ 0       │ 9m     │ 23.730 MB   │ disabled │
└──────────┴────┴──────┴─────┴────────┴─────────┴────────┴─────────────┴──────────┘
</code></pre><h3 id="将-pm2、log4js-日志记录到宿主机文件">将 pm2、log4js 日志记录到宿主机文件</h3><p>这里介绍将 pm2 日志和程序日志记录在宿主机文件之中, 目标是：</p>
<ul>
<li>pm2 out logs =&gt; <code>/data/logs/app-test-out.log</code></li>
<li>pm2 error logs =&gt; <code>/data/logs/app-test-err.log</code></li>
<li>logs by log4js =&gt; <code>/data/logs/hello.log</code></li>
</ul>
<pre><code>./
├── Dockerfile
└── src
    ├── index.js
    ├── package.json
    └── pm2.json
</code></pre><p>Dockerfile</p>
<pre><code>From node:6.3

RUN npm install pm2 -g --registry=https://registry.npm.taobao.org
RUN mkdir -p /usr/src/node-app
WORKDIR /usr/src/node-app

COPY src/. /usr/src/node-app/

RUN npm install --registry=https://registry.npm.taobao.org

EXPOSE  8080

CMD [&quot;npm&quot;, &quot;start&quot;]
</code></pre><p>index.js</p>
<pre><code>const express = require(&#39;express&#39;);
const log4js = require(&#39;log4js&#39;);

// Creates an Express application
let app = express();

// Init logger
log4js.configure({
    appenders: [{
        type: &#39;dateFile&#39;,
        pattern: &#39;-yyyyMMddhh.log&#39;,
        filename: &#39;/data/logs/hello.log&#39;,
        category: &#39;hello&#39;
    }],
    levels: {
        action: &#39;INFO&#39;,                                            
        alarm_api: &#39;INFO&#39;
    }
});

global.logger = log4js.getLogger(&#39;hello&#39;);

// Assigns settings
app.set(&#39;port&#39;, 8080);

// Routes HTTP GET requests 
app.get(&#39;/&#39;, (req, res) =&gt; {
    console.info(&#39;On request: hello world&#39;);
    global.logger.info(req.method, req.path);
    res.send(&#39;Hello world --- from nodejs docker image\n&#39;);
});

// Binds and listens
app.listen(app.get(&#39;port&#39;), () =&gt; {
    console.info(&#39;Listen port %s for app&#39;, app.get(&#39;port&#39;));
});
</code></pre><p>package.json</p>
<pre><code>{
    &quot;name&quot;: &quot;docker-node-test&quot;,
    &quot;private&quot;: true,
    &quot;version&quot;: &quot;0.0.1&quot;,
    &quot;description&quot;: &quot;Node.js test app on node docker image&quot;,
    &quot;author&quot;: &quot;Shaoshuai Dong &lt;dongsoso@hotmail.com&gt;&quot;,
    &quot;scripts&quot;: {
        &quot;start&quot;: &quot;pm2 startOrGracefulReload ./pm2.json --no-daemon&quot;
    },
    &quot;dependencies&quot;: {
        &quot;express&quot;: &quot;^4.13.4&quot;,
        &quot;log4js&quot;: &quot;^0.6.33&quot;                                        
    }
}
</code></pre><p>pm2.json</p>
<pre><code>{
    &quot;apps&quot;: [
        {
            &quot;name&quot;: &quot;app-test&quot;,
            &quot;script&quot;: &quot;index.js&quot;,
            &quot;args&quot;: [],
            &quot;watch&quot;: false,
            &quot;merge_logs&quot;: true,
            &quot;error_file&quot;: &quot;/data/logs/app-test-err.log&quot;,
            &quot;out_file&quot;: &quot;/data/logs/app-test-out.log&quot;,   
            &quot;log_date_format&quot;: &quot;YYYY-MM-DD HH:mm:ss.SSS&quot;,
            &quot;max_memory_restart&quot;: &quot;100M&quot;,
            &quot;env&quot;: {
                &quot;NODE_ENV&quot;: &quot;local&quot;                          
            }
        }
    ]
}
</code></pre><p>创建镜像 <code>docker build --tag=&quot;node/app-test:0.1&quot; ./</code></p>
<p>运行容器 <code>docker run -p 8081:8080 -v /data/logs:/data/logs --name hello node/app-test:0.1</code></p>
<p>使用 <code>-v</code> 参数在容器上挂载宿主机上的指定目录</p>
<p>查看容器和测试:</p>
<pre><code>[root@dss test]# docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                    NAMES
63eb2a3aea8b        node/app-test:0.1   &quot;npm start&quot;         17 seconds ago      Up 16 seconds       0.0.0.0:8081-&gt;8080/tcp   hello
[root@dss test]# curl localhost:8081
Hello world --- from nodejs docker image
[root@dss test]#
</code></pre><p>在宿主机上查看日志</p>
<pre><code>[root@dss test]# ls /data/logs/
app-test-err.log app-test-out.log hello.log
[root@dss test]# cat /data/logs/app-test-out.log 
2016-07-18 05:56:56.406: Listen port 8080 for app
2016-07-18 05:57:21.289: On request: hello world
[root@dss test]# cat /data/logs/hello.log 
[2016-07-18 05:57:21.290] [INFO] hello - GET /
</code></pre><p>命令 <code>docker inspect hello</code> 可以看到容器的 volume 配置</p>
<pre><code>...
 &quot;Volumes&quot;: {
     &quot;/data/logs&quot;: &quot;/data/logs&quot;
 },
 &quot;VolumesRW&quot;: {
     &quot;/data/logs&quot;: true
 },
...
</code></pre><p><code>Data volumes</code> 有如下特性：</p>
<ul>
<li>当容器被创建时 volumes 会被初始化</li>
<li>Data volumes 可以在容器间共享复用</li>
<li>对 data volume 的修改直接生效</li>
<li>更新镜像时， 原来 data volume 的修改不会被影响</li>
<li>即使容器被删除， 对应的 data volumes 依然会存在</li>
</ul>
<p>使用 <code>Volume</code> 可以将容器与容器产生的数据分离，容器产生的数据可以持久化。</p>
<p>Docker volumes 使用 <code>-v</code> 指定和 在 Dockerfile 指定 <code>VOLUME</code> 的区别：</p>
<ul>
<li><code>-v /data/logs:/data/logs</code>: 将宿主机的 <code>/data/logs</code> 目录挂载到容器的 <code>/data/logs</code> 目录(如果目录不存在会被创建)， 宿主机和容器共享该目录，二者对该目录下的修改相互受影响。</li>
<li>Dockerfile 指定 <code>VOLUME /data/logs</code>: 在宿主机创建一个目录(默认是 <code>/var/lib/docker/volumes/</code>)并挂载到容器的 <code>/data/logs</code> 目录(如果目录不存在会被创建), 宿主机和容器共享该目录，二者对该目录下的修改相互受影响。</li>
<li><code>-v /data/logs</code>: 同上， 在宿主机创建一个目录(默认是 <code>/var/lib/docker/volumes/</code>)并挂载到容器的 <code>/data/logs</code> 目录(如果目录不存在会被创建), 宿主机和容器共享该目录，二者对该目录下的修改相互受影响。</li>
</ul>
<p>Docker volumes 默认是 read-write 模式，也可以设置为 read-only 模式。</p>
<h2 id="应用实践-nodejs&amp;mongodb&amp;redis">应用实践 nodejs&amp;mongodb&amp;redis</h2><p>目标</p>
<ul>
<li>container: nodejs <ul>
<li>pm2</li>
<li>logs on host</li>
</ul>
</li>
<li>container: mongodb</li>
<li>container: redis</li>
</ul>
<h3 id="基于-centos-镜像创建-mongodb-镜像">基于 centos 镜像创建 mongodb 镜像</h3><p>新建 Dockerfile</p>
<pre><code># Mongodb image from centos:6
# run -v /data/db:/data/db -p 27017:27017

From centos:6
MAINTAINER Shaoshuai Dong &lt;dongsoso@hotmail.com&gt;

# install mongodb v3.2
COPY mongodb.repo /etc/yum.repos.d/

RUN yum install -y mongodb-org

# volume
VOLUME [&quot;/data/db&quot;]

# expose port
EXPOSE 27017

# command
CMD [&quot;mongod&quot;]
</code></pre><p>mongodb.repo</p>
<pre><code>[MongoDB]
name=MongoDB Repository
baseurl=http://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/3.2/x86_64/
gpgcheck=0
enabled=1
</code></pre><p>创建镜像 <code>docker build --tag=&quot;centos/mongo:0.1&quot; ./</code><br>运行容器 <code>docker run -d -p 27017:27017 -v /data/db:/data/db --name mongo centos/mongo:0.1</code></p>
<p>查看容器运行状态</p>
<pre><code>[root@dss mongodb]# docker ps
CONTAINER ID        IMAGE               COMMAND                CREATED             STATUS              PORTS                              NAMES
c9ddd14992e6        centos/mongo:0.1    &quot;mongod&quot;               5 seconds ago       Up 4 seconds        0.0.0.0:27017-&gt;27017/tcp           mongo
</code></pre><p>测试远程连接 mongodb</p>
<pre><code>[dongshaoshuai~/test] ]$mongo --port 27017 --host x.x.x.x
^[[AMongoDB shell version: 3.0.6
connecting to: x.x.x.x:27017/test
</code></pre><p>也可以通过 Robomongo 远程连接（如果mongodb 版本 &gt;= v3，Robomongo 的版本需 &gt; v0.8.5）</p>
<h3 id="基于-centos-镜像创建-redis-镜像">基于 centos 镜像创建 redis 镜像</h3><p>Dockerfile</p>
<pre><code>From centos:6
MAINTAINER Shaoshuai Dong &lt;dongsoso@hotmail.com&gt;

# install redis v3.2.1
RUN yum install -y gcc-c++
RUN yum install -y tcl
RUN yum install -y wget
RUN wget http://download.redis.io/releases/redis-3.2.1.tar.gz
RUN tar -xzvf redis-3.2.1.tar.gz
RUN mv redis-3.2.1 /usr/local/redis
RUN cd /usr/local/redis; make; make install

COPY redis.conf /etc/redis.conf

EXPOSE 6379

CMD [&quot;/usr/local/bin/redis-server&quot;, &quot;/etc/redis.conf&quot;]
</code></pre><p>redis.conf: <code>wget http://download.redis.io/redis-stable/redis.conf</code> 将 <code>protected-mode yes</code> 改为 <code>protected-mode no</code></p>
<p>创建镜像 <code>docker build --tag=&quot;centos/redis:0.1&quot; ./</code><br>运行容器 <code>docker run -d -p 6379:6379 --name redis centos/redis:0.1</code></p>
<p>查看运行容器</p>
<pre><code>[root@dss redis]# docker ps
CONTAINER ID        IMAGE               COMMAND                CREATED             STATUS              PORTS                      NAMES
5aa2aa34764e        centos/redis:0.1    &quot;/usr/local/bin/redi   6 seconds ago       Up 3 seconds        0.0.0.0:6379-&gt;6379/tcp     redis
c9ddd14992e6        centos/mongo:0.1    &quot;mongod&quot;               2 hours ago         Up 2 hours          0.0.0.0:27017-&gt;27017/tcp   mongo
</code></pre><h3 id="基于-centos-镜像创建-nodejs-服务镜像">基于 centos 镜像创建 nodejs 服务镜像</h3><p>目录结构</p>
<pre><code>├── app
│   ├── index.js
│   ├── package.json
│   └── pm2.json
└── Dockerfile
</code></pre><p>Dockerfile</p>
<pre><code># run -v /data/logs:/data/logs --link mongo:mongo                          

From centos:6
MAINTAINER Shaoshuai Dong &lt;dongsoso@hotmail.com&gt;

# install nodejs v6
RUN curl --silent --location https://rpm.nodesource.com/setup_6.x | bash -
RUN yum -y install nodejs

# install pm2
RUN npm install pm2 -g --registry=https://registry.npm.taobao.org

# make dir
RUN mkdir -p /usr/src/myapp

# envs
ENV NODE_ENV=local

# copy files
COPY app/. /usr/src/myapp/

# work dir
WORKDIR /usr/src/myapp

# install dependencies
RUN npm install --registry=https://registry.npm.taobao.org

# expose port
EXPOSE  8080

# cmd
CMD [&quot;npm&quot;, &quot;start&quot;]
</code></pre><p>package.json</p>
<pre><code>{
    &quot;name&quot;: &quot;docker-node-test&quot;,
    &quot;private&quot;: true,
    &quot;version&quot;: &quot;0.0.1&quot;,
    &quot;description&quot;: &quot;Node.js test app on node docker image&quot;,
    &quot;author&quot;: &quot;Shaoshuai Dong &lt;dongsoso@hotmail.com&gt;&quot;,
    &quot;scripts&quot;: {
        &quot;start&quot;: &quot;pm2 startOrGracefulReload ./pm2.json --no-daemon&quot;
    },
    &quot;dependencies&quot;: {
        &quot;express&quot;: &quot;^4.13.4&quot;,
        &quot;log4js&quot;: &quot;^0.6.33&quot;,                                         
        &quot;mongoose&quot;: &quot;^4.0.8&quot;,
        &quot;express-session&quot;: &quot;^1.13.0&quot;,
        &quot;connect-redis&quot;: &quot;^3.1.0&quot;
    }
}
</code></pre><p>pm2.json</p>
<pre><code>{
    &quot;apps&quot;: [
        {
            &quot;name&quot;: &quot;app&quot;,
            &quot;script&quot;: &quot;index.js&quot;,
            &quot;args&quot;: [],
            &quot;watch&quot;: false,
            &quot;merge_logs&quot;: true,
            &quot;error_file&quot;: &quot;/data/logs/app-err.log&quot;,      
            &quot;out_file&quot;: &quot;/data/logs/app-out.log&quot;,
            &quot;log_date_format&quot;: &quot;YYYY-MM-DD HH:mm:ss.SSS&quot;,
            &quot;max_memory_restart&quot;: &quot;100M&quot;,
            &quot;env&quot;: {
                &quot;NODE_ENV&quot;: &quot;local&quot;
            }
        }
    ]
}
</code></pre><p>一个简单的服务，仅作为演示 index.js</p>
<pre><code>const express = require(&#39;express&#39;);                                                  
const log4js = require(&#39;log4js&#39;);
const mongoose = require(&#39;mongoose&#39;);
const cookieParser = require(&quot;cookie-parser&quot;);
const session = require(&#39;express-session&#39;);
const redisStore = require(&#39;connect-redis&#39;)(session);

// Creates an Express application
let app = express();

// NODE_ENV
const ENV = app.get(&#39;env&#39;);

// Init logger
log4js.configure({
    appenders: [{
        type: &#39;dateFile&#39;,
        pattern: &#39;-yyyyMMddhh.log&#39;,
        filename: &#39;/data/logs/app.log&#39;,
        category: &#39;app&#39;
    }],
    levels: {
        app: &#39;INFO&#39;,
    }
});

global.logger = log4js.getLogger(&#39;app&#39;);

// Assigns settings
app.set(&#39;port&#39;, 8080);

// Middlewares
app.use(cookieParser(&#39;tadf@a213!sdfa6&#39;));
app.use(session({
    secret: &#39;tadf@a213!sdfa6&#39;,
    resave: false,
    saveUninitialized: false,
    store: new redisStore({
        logErrors: true,
        // host: &#39;redis&#39;, // Can be solved by docker-compose
        host: process.env.REDIS_PORT_6379_TCP_ADDR,
        port: 6379,
        ttl: 60 // expiration in 60s
    })
}));

// MongoDB connection: &#39;mongo&#39; resolves to a docker container
let mongoUrl = &#39;mongodb://mongo:27017/test&#39;;
mongoose.connect(mongoUrl);
let Monkey = mongoose.model(&#39;Monkey&#39;, { name: String });

/**
 * Routes HTTP GET requests 
 */

app.all(&#39;*&#39;, (req, res, next) =&gt; {
    global.logger.info(req.method, req.path);

    if (req.path === &#39;/login&#39;) {
        next();
        return;
    }

    if (!req.session || !req.session.isLoggedIn) {
        // TODO: redirect to login page
        res.send(&#39;Please login first&#39;);
        return;
    }
    next();
});

app.get(&#39;/login&#39;, (req, res) =&gt; {
    let userName = &#39;admin&#39;;
    let password = &#39;admin&#39;;

    if (req.query.name === userName &amp;&amp; req.query.password === password) {
        req.session.isLoggedIn = true;
        res.json({
            RetCode: 0
        });
        return;
    }

    res.json({
        RetCode: 5,
        ErrMsg: &#39;Username or password wrong&#39;
    });
});

app.get(&#39;/hello&#39;, (req, res) =&gt; {
    console.info(&#39;On request: hello world&#39;);
    res.send(&#39;Hello world --- from nodejs docker image\n&#39;); 
});

app.get(&#39;/mongo/insert&#39;, (req, res) =&gt; {
    let newData = { name: req.query.name };
    let newMonkey = new Monkey(newData);

    newMonkey.save(err =&gt; {
        if (err) {
            global.logger.error(&#39;Insert data failed: &#39;, err, newData); 
            res.json({
                RetCode: 100,
                ErrMsg: &#39;Insert data failed&#39;
            });
            return;
        }

        global.logger.info(&#39;Insert data success:&#39;, newData);
        res.json({
            RetCode: 0
        });
    });
});

app.get(&#39;/mongo/find&#39;, (req, res) =&gt; {
    Monkey.find((err, monkeys) =&gt; {
        if (err) {
            global.logger.error(&#39;Find data failed: &#39;, err); 
            res.json({
                RetCode: 200,
                ErrMsg: &#39;Find data failed&#39;
            });
            return;
        }

        global.logger.info(&#39;Find data success:&#39;, monkeys);
        res.json({
            RetCode: 0,
            Data: monkeys
        });
    });
});

// Binds and listens
app.listen(app.get(&#39;port&#39;), () =&gt; {
    console.info(&#39;Listen port %s for app&#39;, app.get(&#39;port&#39;));
    console.info(&#39;NODE_ENV&#39;, ENV);
});
</code></pre><p>创建镜像 <code>docker build --tag=&quot;centos/node-app:0.1&quot; ./</code></p>
<p>运行容器 <code>docker run -d -p 8181:8080 -v /data/logs:/data/logs --link mongo:mongo --link redis:redis --name app centos/node-app:0.1</code></p>
<p>查看服务状态</p>
<pre><code>[root@dss app]# docker exec app pm2 list
┌──────────┬────┬──────┬─────┬────────┬─────────┬────────┬─────────────┬──────────┐
│ App name │ id │ mode │ pid │ status │ restart │ uptime │ memory      │ watching │
├──────────┼────┼──────┼─────┼────────┼─────────┼────────┼─────────────┼──────────┤
│ app      │ 0  │ fork │ 25  │ online │ 0       │ 21s    │ 47.879 MB   │ disabled │
└──────────┴────┴──────┴─────┴────────┴─────────┴────────┴─────────────┴──────────┘
 Use `pm2 show &lt;id|name&gt;` to get more details about an app
</code></pre><h3 id="测试">测试</h3><p>未登录, 在浏览器访问 <code>yourhost:8181/hello</code></p>
<pre><code>Please log in first
</code></pre><p>登录, <code>yourhost:8181/login?name=admin&amp;password=admin</code></p>
<pre><code>{
    &quot;RetCode&quot;: 0
}
</code></pre><p>登陆后，测试 <code>yourhost:8181/hello</code></p>
<pre><code>Hello world --- from nodejs docker image
</code></pre><p>测试 <code>yourhost:8181/mongo/find</code></p>
<pre><code>{&quot;RetCode&quot;:0,&quot;Data&quot;:[{&quot;_id&quot;:&quot;578ded8321be5919003c0dd8&quot;,&quot;name&quot;:&quot;mmmm&quot;,&quot;__v&quot;:0},{&quot;_id&quot;:&quot;578df6f638a6a11b008a9bd0&quot;,&quot;name&quot;:&quot;mmmmmm&quot;,&quot;__v&quot;:0}]}
</code></pre><p>查看日志</p>
<pre><code>[root@dss logs]# cat /data/logs/app.log 
[2016-07-20 02:31:40.097] [INFO] app - GET /hello
[2016-07-20 02:31:45.088] [INFO] app - GET /login
[2016-07-20 02:32:12.375] [INFO] app - GET /hello
[2016-07-20 02:32:16.476] [INFO] app - GET /mongo/find
[2016-07-20 02:32:16.477] [INFO] app - Find data success: [ { _id: 578ded8321be5919003c0dd8, name: &#39;mmmm&#39;, __v: 0 },
  { _id: 578df6f638a6a11b008a9bd0, name: &#39;mmmmmm&#39;, __v: 0 } ]
</code></pre><h2 id="其他">其他</h2><h3 id="修改镜像、容器存储目录">修改镜像、容器存储目录</h3><p>docker 镜像、容器默认存储在 <code>/var/lib/docker</code>，对于云主机通常系统盘不大，最好存储在数据盘。</p>
<p>通过 <code>--graph</code> 参数可以指定存储位置。修改 <code>/etc/sysconfig/docker</code> 文件：</p>
<pre><code># 数据盘
other_args=&quot;--graph=/data/docker&quot;
</code></pre><p>停止 docker 服务 <code>service docker stop</code></p>
<p>copy 数据至数据盘 <code>cp -r /var/lib/docker /data/docker/</code></p>
<p>移除、备份原数据 <code>mv /var/lib/docker /data/bak/docker.bak</code></p>
<p>重新启动 docker 服务 <code>service docker start</code></p>
<p>测试镜像和容器是否正常 <code>docker images</code>, <code>docker ps -a</code> </p>

</div>
<div class="footer">
    作者/版权: <a href="mailto:dongsoso@hotmail.com?subject=Dogs%20Blog%20Email">Dogs</a> | 纠错/贡献: <a href="https://github.com/Dongss/dogs/tree/master/posts/ops/7.md">Contribute</a>
</div>
    </body>
    <script src="http://cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
    <script src="../dist/post.build.js"></script>
    <script type="text/javascript">
        hljs.initHighlightingOnLoad();
    </script>
</html>

