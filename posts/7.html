<!DOCTYPE html>
<html>
    
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <title>
            Start Node.Js process with PM2 in a Docker container - Dogs Blog
        </title>
        <link rel="shortcut icon" href="../dist/favicon.ico">
        <link rel="stylesheet" href="../dist/post.style.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/github-markdown-css/2.2.1/github-markdown.css">
        <link rel="stylesheet" href="http://cdn.bootcss.com/highlight.js/9.2.0/styles/github-gist.min.css">
    </head>
    
    <body>
        <div class="header">
            <a href="../">Dogs Blog</a>
            <button class="label reverse"><a href="../#/category/all">返回列表</a></button>
        </div>

<div class="post-header">
    分类: OPS | 发布日期: 2016-07-17
</div>
<div class="divider"></div>
<div class="markdown-body">
    <h1 id="start-nodejs-process-with-pm2-in-a-docker-container">Start Node.Js process with PM2 in a Docker container</h1><!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<ul>
<li><a href="#%E7%8E%AF%E5%A2%83">环境</a></li>
<li><a href="#%E4%B8%8B%E8%BD%BD%E4%BD%BF%E7%94%A8%E9%95%9C%E5%83%8F">下载使用镜像</a></li>
<li><a href="#%E5%9F%BA%E4%BA%8E-nodejs-%E9%95%9C%E5%83%8F%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1%E9%95%9C%E5%83%8F">基于 Node.Js 镜像创建服务镜像</a></li>
<li><a href="#%E5%9F%BA%E4%BA%8E-nodejs-%E9%95%9C%E5%83%8F%E4%BD%BF%E7%94%A8-pm2">基于 Node.Js 镜像使用 pm2</a><ul>
<li><a href="#%E4%BD%BF%E7%94%A8-pm2">使用 pm2</a></li>
<li><a href="#%E5%B0%86-pm2%E3%80%81log4js-%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E5%88%B0%E5%AE%BF%E4%B8%BB%E6%9C%BA%E6%96%87%E4%BB%B6">将 pm2、log4js 日志记录到宿主机文件</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="环境">环境</h2><ul>
<li>系统环境 centos 6.5 64bit</li>
<li>docker v1.7.1</li>
</ul>
<h2 id="下载使用镜像">下载使用镜像</h2><pre><code>[root@dss ~]# docker search node # 搜素镜像
NAME                      DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED
node                      Node.js is a JavaScript-based platform for...   2462      [OK]       
strongloop/node           StrongLoop, Node.js, and tools.                 30                   [OK]
bitnami/node              Bitnami Node.js Docker Image                    16                   [OK]
siomiz/node-opencv        _/node + node-opencv                            8                    [OK]
dahlb/alpine-node         small node for gitlab ci runner                 7                    [OK]
tatsushid/tinycore-node   A small but a fully functional Node.js run...   6                    [OK]
cusspvz/node               Super small Node.js container (~20MB)...      4                    [OK]
azukiapp/node             Docker image to run Node.js by Azuki - htt...   4                    [OK]
tutum/node                Run a Tutum node inside a container             3                    [OK]
anigeo/node-forever       Daily build node.js with forever                3                    [OK]
redjack/node              Node + Nave                                     1                    [OK]
xataz/node                very light node image                           1                    [OK]
joxit/node                Slim node docker with some utils for dev        1                    [OK]
centralping/node          Bare bones CentOS 7 NodeJS container.           1                    [OK]
urbanmassage/node         Some handy (read, better) docker node images    1                    [OK]
tectoro/node-compass      Node JS minimal version with compass and b...   1                    [OK]
starefossen/ruby-node     Docker Image with Ruby and Node.js installed    1                    [OK]
atomiq/node               Use as base image for new Node.js images.       1                    [OK]
robbertkl/node            Docker container running Node.js                0                    [OK]
lynxtp/node               https://github.com/lynxtp/docker-node           0                    [OK]
codexsystems/node         Node.js for Development and Production          0                    [OK]
instructure/node          Instructure node images                         0                    [OK]
stylisted/node            Stylisted&#39;s base Docker node image with gr...   0                    [OK]
maxird/node               Node                                            0                    [OK]
c4tech/node               NodeJS images, aimed at generated single-p...   0                    [OK]
</code></pre><p>安装 Node.Js 官方镜像 <code>[root@dss ~]# yum pull node</code></p>
<p>查看已安装镜像</p>
<pre><code>[root@dss workspace]# docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
node                latest              47abb70784d6        8 days ago          660.6 MB
</code></pre><h2 id="基于-nodejs-镜像创建服务镜像">基于 Node.Js 镜像创建服务镜像</h2><p>新建目录 <code>src</code>, 在src目录下新建 <code>package.json</code>:</p>
<pre><code>{
    &quot;name&quot;: &quot;docker-node-test&quot;,
    &quot;private&quot;: true,
    &quot;version&quot;: &quot;0.0.1&quot;,
    &quot;description&quot;: &quot;Node.js test app on node docker image&quot;,
    &quot;author&quot;: &quot;Shaoshuai Dong &lt;dongsoso@hotmail.com&gt;&quot;,
    &quot;dependencies&quot;: {
        &quot;express&quot;: &quot;^4.13.4&quot;                                
    }
}
</code></pre><p>在src目录下新建<code>index.js</code>:</p>
<pre><code> const express = require(&#39;express&#39;);

 // Creates an Express application
 let app = express();

 // Assigns settings
 app.set(&#39;port&#39;, 8080);

 // Routes HTTP GET requests 
 app.get(&#39;/&#39;, (req, res) =&gt; {
     res.send(&#39;Hello world --- from nodejs docker image\n&#39;);
 });                                                          

 // Binds and listens
 app.listen(app.get(&#39;port&#39;), () =&gt; {
     console.info(&quot;Listen port %s for app&quot;, app.get(&quot;port&quot;));
</code></pre><p>在src同级目录下新建文件 <code>Dockerfile</code>: </p>
<pre><code>From node:6.3

ADD src/ /src

RUN cd /src; npm install

EXPOSE  8080

CMD [&quot;node&quot;, &quot;/src/index.js&quot;]
</code></pre><p>创建镜像 <code>docker build --tag=&quot;node/app-test&quot; ./</code>, <code>docker build --help</code> 查看详细参数</p>
<p>创建成功会提示 <code>Successfully built 2199b2aa9cd1</code></p>
<p>查看创建的镜像</p>
<pre><code>[root@dss test]# docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
node/app-test       latest              2199b2aa9cd1        7 seconds ago       663.6 MB
node                6.3                 47abb70784d6        8 days ago          660.6 MB
node                latest              47abb70784d6        8 days ago          660.6 MB
</code></pre><p>运行刚刚创建的镜像, <code>docker run --help</code> 查看详细参数：</p>
<pre><code>[root@dss test]# docker run -d -p 8081:8080 node/app-test 
873ac198368799f9bf56262e097f55e66241f47cedd336349236b43e9001539d
</code></pre><p>查看运行中的容器，是否存在：</p>
<pre><code>[root@dss test]# docker ps
CONTAINER ID        IMAGE               COMMAND                CREATED             STATUS              PORTS                    NAMES
873ac1983687        node/app-test       &quot;node /src/index.js&quot;   53 seconds ago      Up 52 seconds       0.0.0.0:8081-&gt;8080/tcp   desperate_swartz
</code></pre><p>测试 Node.Js 服务：</p>
<pre><code>[root@dss ~]# curl localhost:8081 -i
HTTP/1.1 200 OK
X-Powered-By: Express
Content-Type: text/html; charset=utf-8
Content-Length: 41
ETag: W/&quot;29-onjHxbOtTbPH0+vlfe2YtA&quot;
Date: Fri, 15 Jul 2016 10:49:54 GMT
Connection: keep-alive

Hello world --- from nodejs docker image
</code></pre><h2 id="基于-nodejs-镜像使用-pm2">基于 Node.Js 镜像使用 pm2</h2><h3 id="使用-pm2">使用 pm2</h3><p>创建 <code>Dockerfile</code>:</p>
<pre><code>From node:6.3

RUN npm install pm2 -g --registry=https://registry.npm.taobao.org
RUN mkdir -p /usr/src/node-app
WORKDIR /usr/src/node-app

COPY src/. /usr/src/node-app/

RUN npm install --registry=https://registry.npm.taobao.org

EXPOSE  8080

CMD [&quot;npm&quot;, &quot;start&quot;]
</code></pre><p>先看看目录结构吧</p>
<pre><code>[root@dss workspace]# tree test/
test/
├── Dockerfile
└── src
    ├── index.js
    ├── package.json
    └── pm2.json
</code></pre><p><code>package.json</code>:</p>
<pre><code>{                                                           
    &quot;name&quot;: &quot;docker-node-test&quot;,                             
    &quot;private&quot;: true,                                        
    &quot;version&quot;: &quot;0.0.1&quot;,                                     
    &quot;description&quot;: &quot;Node.js test app on node docker image&quot;, 
    &quot;author&quot;: &quot;Shaoshuai Dong &lt;dongsoso@hotmail.com&gt;&quot;,      
    &quot;scripts&quot;: {                                            
        &quot;start&quot;: &quot;pm2 startOrGracefulReload ./pm2.json --no-daemon&quot;     
    },                                                      
    &quot;dependencies&quot;: {                                       
        &quot;express&quot;: &quot;^4.13.4&quot;                                
    }                                                       
}
</code></pre><p><code>index.js</code></p>
<pre><code>const express = require(&#39;express&#39;);

// Creates an Express application
let app = express();

// Assigns settings
app.set(&#39;port&#39;, 8080);

// Routes HTTP GET requests                                       
app.get(&#39;/&#39;, (req, res) =&gt; {
    res.send(&#39;Hello world --- from nodejs docker image\n&#39;);
});

// Binds and listens
app.listen(app.get(&#39;port&#39;), () =&gt; {
    console.info(&quot;Listen port %s for app&quot;, app.get(&quot;port&quot;));
});
</code></pre><p><code>pm2.json</code>:</p>
<pre><code>{                                         
    &quot;apps&quot;: [
        {
            &quot;name&quot;: &quot;app-test&quot;,
            &quot;script&quot;      : &quot;index.js&quot;,
            &quot;args&quot;        : [],
            &quot;watch&quot;       : false,
            &quot;merge_logs&quot;  : true,
            &quot;max_memory_restart&quot;: &quot;100M&quot;,
            &quot;env&quot;: {
                &quot;NODE_ENV&quot;: &quot;local&quot;
            }
        }
    ]
}
</code></pre><p>创建镜像 <code>docker build --tag=&quot;node/app-test&quot; ./</code></p>
<p>查看创建的镜像 <code>docker images</code>:</p>
<pre><code>[root@dss test]# docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
node/app-test       latest              1a3325c28c8c        14 minutes ago      678 MB
node                latest              47abb70784d6        10 days ago         660.6 MB
node                6.3                 47abb70784d6        10 days ago         660.6 MB
</code></pre><p>运行 <code>docker run -d -p 8081:8080 node/app-test</code></p>
<p>查看运行中的容器</p>
<pre><code>[root@dss test]# docker ps
CONTAINER ID        IMAGE               COMMAND                CREATED             STATUS              PORTS                    NAMES
9e49f7c5270a        node/app-test       &quot;pm2 start index.js    7 minutes ago       Up 7 minutes        0.0.0.0:8081-&gt;8080/tcp   gloomy_sammet
</code></pre><p>测试</p>
<pre><code>[root@dss test]# curl -i localhost:8081
HTTP/1.1 200 OK
X-Powered-By: Express
Content-Type: text/html; charset=utf-8
Content-Length: 41
ETag: W/&quot;29-onjHxbOtTbPH0+vlfe2YtA&quot;
Date: Sun, 17 Jul 2016 09:12:48 GMT
Connection: keep-alive

Hello world --- from nodejs docker image
</code></pre><p>在容器内运行命令(<code>docker exec --help</code> 查看更多用法)</p>
<pre><code>[root@dss test]# docker exec -i 9e49f7c5270a pm2 list
┌──────────┬────┬──────┬─────┬────────┬─────────┬────────┬─────────────┬──────────┐
│ App name │ id │ mode │ pid │ status │ restart │ uptime │ memory      │ watching │
├──────────┼────┼──────┼─────┼────────┼─────────┼────────┼─────────────┼──────────┤
│ app-test │ 0  │ fork │ 17  │ online │ 0       │ 9m     │ 23.730 MB   │ disabled │
└──────────┴────┴──────┴─────┴────────┴─────────┴────────┴─────────────┴──────────┘
</code></pre><h3 id="将-pm2、log4js-日志记录到宿主机文件">将 pm2、log4js 日志记录到宿主机文件</h3><p>这里介绍将 pm2 日志和程序日志记录在宿主机文件之中, 目标是：</p>
<ul>
<li>pm2 out logs =&gt; <code>/data/logs/app-test-out.log</code></li>
<li>pm2 error logs =&gt; <code>/data/logs/app-test-err.log</code></li>
<li>logs by log4js =&gt; <code>/data/logs/hello.log</code></li>
</ul>
<pre><code>./
├── Dockerfile
└── src
    ├── index.js
    ├── package.json
    └── pm2.json
</code></pre><p>Dockerfile</p>
<pre><code>From node:6.3

RUN npm install pm2 -g --registry=https://registry.npm.taobao.org
RUN mkdir -p /usr/src/node-app
WORKDIR /usr/src/node-app

COPY src/. /usr/src/node-app/

RUN npm install --registry=https://registry.npm.taobao.org

EXPOSE  8080

CMD [&quot;npm&quot;, &quot;start&quot;]
</code></pre><p>index.js</p>
<pre><code>const express = require(&#39;express&#39;);
const log4js = require(&#39;log4js&#39;);

// Creates an Express application
let app = express();

// Init logger
log4js.configure({
    appenders: [{
        type: &quot;dateFile&quot;,
        pattern: &quot;-yyyyMMddhh.log&quot;,
        filename: &quot;/data/logs/hello.log&quot;,
        category: &quot;hello&quot;
    }],
    levels: {
        action: &quot;INFO&quot;,                                            
        alarm_api: &quot;INFO&quot;
    }
});

global.logger = log4js.getLogger(&#39;hello&#39;);

// Assigns settings
app.set(&#39;port&#39;, 8080);

// Routes HTTP GET requests 
app.get(&#39;/&#39;, (req, res) =&gt; {
    console.info(&#39;On request: hello world&#39;);
    global.logger.info(req.method, req.path);
    res.send(&#39;Hello world --- from nodejs docker image\n&#39;);
});

// Binds and listens
app.listen(app.get(&#39;port&#39;), () =&gt; {
    console.info(&quot;Listen port %s for app&quot;, app.get(&quot;port&quot;));
});
</code></pre><p>package.json</p>
<pre><code>{
    &quot;name&quot;: &quot;docker-node-test&quot;,
    &quot;private&quot;: true,
    &quot;version&quot;: &quot;0.0.1&quot;,
    &quot;description&quot;: &quot;Node.js test app on node docker image&quot;,
    &quot;author&quot;: &quot;Shaoshuai Dong &lt;dongsoso@hotmail.com&gt;&quot;,
    &quot;scripts&quot;: {
        &quot;start&quot;: &quot;pm2 startOrGracefulReload ./pm2.json --no-daemon&quot;
    },
    &quot;dependencies&quot;: {
        &quot;express&quot;: &quot;^4.13.4&quot;,
        &quot;log4js&quot;: &quot;^0.6.33&quot;                                        
    }
}
</code></pre><p>pm2.json</p>
<pre><code>{
    &quot;apps&quot;: [
        {
            &quot;name&quot;: &quot;app-test&quot;,
            &quot;script&quot;: &quot;index.js&quot;,
            &quot;args&quot;: [],
            &quot;watch&quot;: false,
            &quot;merge_logs&quot;: true,
            &quot;error_file&quot;: &quot;/data/logs/app-test-err.log&quot;,
            &quot;out_file&quot;: &quot;/data/logs/app-test-out.log&quot;,   
            &quot;log_date_format&quot;: &quot;YYYY-MM-DD HH:mm:ss.SSS&quot;,
            &quot;max_memory_restart&quot;: &quot;100M&quot;,
            &quot;env&quot;: {
                &quot;NODE_ENV&quot;: &quot;local&quot;                          
            }
        }
    ]
}
</code></pre><p>创建镜像 <code>docker build --tag=&quot;node/app-test:0.1&quot; ./</code></p>
<p>运行容器 <code>docker run -p 8081:8080 -v /data/logs:/data/logs --name hello node/app-test:0.1</code></p>
<p>使用 <code>-v</code> 参数在容器上挂载宿主机上的指定目录</p>
<p>查看容器和测试:</p>
<pre><code>[root@dss test]# docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                    NAMES
63eb2a3aea8b        node/app-test:0.1   &quot;npm start&quot;         17 seconds ago      Up 16 seconds       0.0.0.0:8081-&gt;8080/tcp   hello
[root@dss test]# curl localhost:8081
Hello world --- from nodejs docker image
[root@dss test]#
</code></pre><p>在宿主机上查看日志</p>
<pre><code>[root@dss test]# ls /data/logs/
app-test-err.log app-test-out.log hello.log
[root@dss test]# cat /data/logs/app-test-out.log 
2016-07-18 05:56:56.406: Listen port 8080 for app
2016-07-18 05:57:21.289: On request: hello world
[root@dss test]# cat /data/logs/hello.log 
[2016-07-18 05:57:21.290] [INFO] hello - GET /
</code></pre><p>命令 <code>docker inspect hello</code> 可以看到容器的 volume 配置</p>
<pre><code>...
 &quot;Volumes&quot;: {
     &quot;/data/logs&quot;: &quot;/data/logs&quot;
 },
 &quot;VolumesRW&quot;: {
     &quot;/data/logs&quot;: true
 },
...
</code></pre>
</div>
<div class="footer">
    作者/版权: <a href="mailto:dongsoso@hotmail.com?subject=Dogs%20Blog%20Email">Dogs</a> | 纠错/贡献: <a href="https://github.com/Dongss/dogs/tree/master/posts/ops/7.md">Contribute</a>
</div>
    </body>
    <script src="http://cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
    <script src="../dist/post.build.js"></script>
    <script type="text/javascript">
        hljs.initHighlightingOnLoad();
    </script>
</html>

