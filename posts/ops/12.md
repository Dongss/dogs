# Build golang http server with docker

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->


- [环境](#%E7%8E%AF%E5%A2%83)
- [构建server代码](#%E6%9E%84%E5%BB%BAserver%E4%BB%A3%E7%A0%81)
- [打包镜像](#%E6%89%93%E5%8C%85%E9%95%9C%E5%83%8F)
- [测试](#%E6%B5%8B%E8%AF%95)
- [依赖管理](#%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86)
  - [构建包含dep的基础golang镜像](#%E6%9E%84%E5%BB%BA%E5%8C%85%E5%90%ABdep%E7%9A%84%E5%9F%BA%E7%A1%80golang%E9%95%9C%E5%83%8F)
  - [构建服务镜像](#%E6%9E%84%E5%BB%BA%E6%9C%8D%E5%8A%A1%E9%95%9C%E5%83%8F)
  - [测试镜像](#%E6%B5%8B%E8%AF%95%E9%95%9C%E5%83%8F)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## 环境

* Go: v1.10
* Docker: v18.03
* OS: CentOS 7.4

## 构建server代码

server.go

```
package main

import (
	"fmt"
	"net/http"
	"log"
)

func hello(w http.ResponseWriter, r *http.Request) {
	fmt.Println("path", r.URL.Path)
	fmt.Fprintf(w, "Hello there!")
}

func main() {
	http.HandleFunc("/", hello) 
	err := http.ListenAndServe(":9090", nil)
	if err != nil {
		log.Fatal("ListenAndServe: ", err)
	}
}
```

## 打包镜像

dockerfile:

```
FROM golang:1.10
RUN mkdir /app 
ADD . /app/ 
WORKDIR /app
RUN go build -o main . 
CMD ["/app/main"]
```

编译镜像：

`docker build -t go-server:test .`

## 测试

`docker run --rm -p 9099:9099 go-server:test`

访问 `localhost:9099/tttt`

输出：

```
path /tttt
```

## 依赖管理

由于国内下载 go 依赖很多不方便，这里使用 [dep](https://github.com/golang/dep) 做依赖管理，构建镜像时不需要每次下载依赖。

安装日志库 `dep ensure --add github.com/sirupsen/logrus`

修改代码：

```
package main

import (
	"net/http"

	log "github.com/sirupsen/logrus"
)

func hello(w http.ResponseWriter, r *http.Request) {
	log.Info("path", r.URL.Path)
	log.Info(w, "Hello there!")
}

func main() {
	http.HandleFunc("/", hello)
	err := http.ListenAndServe(":9099", nil)
	if err != nil {
		log.Fatal("ListenAndServe: ", err)
	}
}

```

### 构建包含dep的基础golang镜像

下载最新的 [dep release](https://github.com/golang/dep/releases)

给下载好的`dep-linux-amd64`文件增加执行权限

dockerfile:

```
FROM golang:1.10

# Set go bin which doesn't appear to be set already.
ENV GOBIN /go/bin
# GO dep
COPY dep-linux-amd64 /go/bin/dep
```

构建镜像  `docker build -t mygolang:1.10 .`

### 构建服务镜像

dockerfile:

```
FROM mygolang:1.10

# Build directories
RUN mkdir /app
RUN mkdir /go/src/app
ADD . /go/src/app
WORKDIR /go/src/app

# Install dependencies
RUN dep ensure

# Build my app
RUN go build -o /app/main .
CMD ["/app/main"]
```

构建镜像：

`docker build -t golang-server:test .`

### 测试镜像

运行：

`docker run --rm golang-server:test`


测试：

`curl 127.0.0.1:9099`

输出：

`"level":"info","msg":"path/","time":"2018-11-07T05:18:18Z"}`



