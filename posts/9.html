<!DOCTYPE html>
<html>
    
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <title>
            Promise Magic - Dogs Blog
        </title>
        <link rel="shortcut icon" href="../dist/favicon.ico">
        <link rel="stylesheet" href="../dist/post.style.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/github-markdown-css/2.2.1/github-markdown.css">
        <link rel="stylesheet" href="http://cdn.bootcss.com/highlight.js/9.2.0/styles/github-gist.min.css">
    </head>
    
    <body>
        <div class="header">
            <button class="label reverse"><a href="../#/category/all">返回列表</a></button>
        </div>

<div class="post-header">
    分类: JavaScript | 发布日期: 2016-12-01
</div>
<div class="divider"></div>
<div class="markdown-body">
    <h1 id="promise-magic">Promise Magic</h1><!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<ul>
<li><a href="#chain-code">Chain code</a></li>
<li><a href="#queue-operation">Queue operation</a></li>
<li><a href="#batch-async">Batch async</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="chain-code">Chain code</h2><pre><code>function __async(v) {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(function() {
      console.log(&#39;CB:&#39;, v);
      resolve(v);
    }, 500);
  });
}

/*
 bad
 nested .then()
 puzzled
*/
__async(1).then(v =&gt; {                                
  console.log(v);
  __async(2)
  .then(vv =&gt; {
    console.log(vv);
    __async(3).then(vvv =&gt; {
      console.log(vvv);
    })
  })
});

/*
 good
 chain code
 readable
*/
__async(1).then(v =&gt; {
  console.log(v);
  return __async(2);
}).then(v =&gt; {
  console.log(v);
  return __async(3);
}).then(v =&gt; {
  console.log(v);
});
</code></pre><h2 id="queue-operation">Queue operation</h2><pre><code>function queueOp() {                                    
  let qLocks = {};

  function scheduleNextOp(qId) {
    let opLock = qLocks[qId];
    if (!opLock) {
      return;
    }
    if (opLock.next.length === 0) {
      delete qLocks[qId];
      return;
    }
    let n = opLock.next.shift();
    n.resolve(null);
  }

  /*
   @param {String} qId, unique
   @param {Function} op, function which returns a Promise
  */
  return function(qId, op) {
    return new Promise((resolve, reject) =&gt; {
      let opLock = qLocks[qId];
      if (!opLock) {
        qLocks[qId] = opLock = {
          next: []
        }
        resolve();
      } else {
        opLock.next.push({resolve, reject});
      }
    }).then(() =&gt; {
      return op();
    }).then((v) =&gt; {
      scheduleNextOp(qId);
      return v;
    }).catch(e =&gt; {
      scheduleNextOp(qId);
      throw e;
    });
  }
}
</code></pre><p>test:</p>
<pre><code>function __async(v, t) {
  return new Promise((resolve, reject) =&gt; {
    console.log(Date.now(), &#39;Start&#39;, v);
    setTimeout(() =&gt; {
      console.log(Date.now(), &#39;End&#39;, v);
      resolve(v);
    }, t);
  });
}

try {
  let myQueueOp = queueOp();
  myQueueOp(&#39;test&#39;, () =&gt; {
    return __async(1111, 1000);
  });
  myQueueOp(&#39;test&#39;, () =&gt; {
    return __async(2222, 2000);
  });
  myQueueOp(&#39;test&#39;, () =&gt; {
    return __async(3333, 1000);
  });
} catch (e) {
  console.error(e);
}
</code></pre><p>output:</p>
<pre><code>1480915146233 &#39;Start&#39; 1111
1480915147239 &#39;End&#39; 1111
1480915147242 &#39;Start&#39; 2222
1480915149245 &#39;End&#39; 2222
1480915149246 &#39;Start&#39; 3333
1480915150247 &#39;End&#39; 3333
</code></pre><h2 id="batch-async">Batch async</h2><pre><code>/*
 @param {Number} step
 @param {Array} ps, Array of function which returns a Promise
*/
function batchAsync(step, ps) {                                          
  let result = [];
  return function batch(ps) {
    if (ps.length &gt; step) {
      return Promise.all(ps.slice(0, step).map((f)=&gt;f())).then(vs =&gt; {
        console.log(&#39;Done:&#39;, vs);
        result = result.concat(vs);
        return batch(ps.slice(step, ps.length));
      });
    } else {
      return Promise.all(ps.map((f)=&gt;f())).then(vs =&gt; {
        result = result.concat(vs);
        console.log(&#39;Done:&#39;, vs);
        return Promise.resolve(result);
      });
    }
  }
}
</code></pre><p>test:</p>
<pre><code>function __batch(v) {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      console.log(&#39;CB:&#39;, v)
      resolve(v);
    }, 500)
  });
}

let myBatch = batchAsync(5);
let ps = [];

for (let i = 0; i &lt; 21; i++) {
  ps.push(function() {
    return __batch(i);
  });
}

myBatch(ps).then(v =&gt; {
  console.log(&#39;ALL DONE:&#39;, v);
}).catch(e =&gt; {
  console.error(&#39;Batch error:&#39;, e)
});
</code></pre><p>output:</p>
<pre><code>CB: 0
CB: 1
CB: 2
CB: 3
CB: 4
Done: [ 0, 1, 2, 3, 4 ]
CB: 5
CB: 6
CB: 7
CB: 8
CB: 9
Done: [ 5, 6, 7, 8, 9 ]
CB: 10
CB: 11
CB: 12
CB: 13
CB: 14
Done: [ 10, 11, 12, 13, 14 ]
CB: 15
CB: 16
CB: 17
CB: 18
CB: 19
Done: [ 15, 16, 17, 18, 19 ]
CB: 20
Done: [ 20 ]
ALL DONE: [ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20 ]
</code></pre>
</div>
<div class="footer">
    作者/版权: <a href="mailto:dongsoso@hotmail.com?subject=Dogs%20Blog%20Email">Dogs</a> | 纠错/贡献: <a href="https://github.com/Dongss/dogs/tree/master/posts/javascript/9.md">Contribute</a>
</div>
    </body>
    <script src="http://cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
    <script src="../dist/post.build.js"></script>
    <script type="text/javascript">
        hljs.initHighlightingOnLoad();
    </script>
</html>

